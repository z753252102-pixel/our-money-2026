<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ­ 2026 æ˜èˆ‡è±çš„é¦¬å¡é¾é‡‘åº«</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');
        :root {
            --macaron-pink: #FFB7B2; --macaron-yellow: #FFDAC1; --macaron-green: #E2F0CB;
            --macaron-blue: #B5EAD7; --macaron-purple: #C7CEEA;
            --bg-gradient: linear-gradient(120deg, #fccb90 0%, #d57eeb 100%);
            --card-bg: rgba(255, 255, 255, 0.9);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Nunito', sans-serif; background-image: var(--bg-gradient); background-attachment: fixed; margin: 0; padding: 10px; display: flex; justify-content: center; min-height: 100vh; color: #555; overflow-x: hidden; }
        .container { width: 100%; max-width: 600px; background: var(--card-bg); border-radius: 30px; padding: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); backdrop-filter: blur(10px); border: 4px solid #fff; position: relative; z-index: 10; }
        
        header { text-align: center; margin-bottom: 15px; }
        h1 { color: #6e45e2; font-size: 1.5rem; margin: 0; text-shadow: 1px 1px 0 white; }
        .user-switcher { display: flex; justify-content: center; gap: 8px; margin: 15px 0; }
        .user-btn { padding: 8px 20px; border-radius: 50px; border: 2px solid #6e45e2; background: white; color: #6e45e2; font-weight: 800; cursor: pointer; transition: 0.3s; }
        .user-btn.active { background: #6e45e2; color: white; }
        .sync-status { font-size: 0.75rem; color: #888; margin-top: 5px; font-weight: bold; }

        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { text-align: center; padding: 12px; border-radius: 20px; background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s; }
        .stat-box:active { transform: scale(0.95); }
        .full-width { grid-column: span 2; background: linear-gradient(135deg, #fff 0%, #fff0f5 100%); border: 2px solid #ffb7b2; }
        .stat-label { font-size: 0.75rem; font-weight: 700; opacity: 0.8; margin-bottom: 3px; }
        .stat-value { font-size: 1.2rem; font-weight: 800; color: #444; }
        .highlight { color: #e83e8c; }

        .progress-section { margin: 15px 0; font-size: 0.8rem; font-weight: 700; }
        .progress-info { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .progress-container { width: 100%; background: #eee; border-radius: 50px; height: 12px; overflow: hidden; border: 1px solid #ddd; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ff9a9e, #fad0c4); transition: width 0.8s ease; }
        .bar-2026 { background: linear-gradient(90deg, #a18cd1, #fbc2eb); }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(42px, 1fr)); gap: 8px; margin-top: 15px; }
        .day-box { aspect-ratio: 1; border-radius: 50%; border: 2px solid #eee; display: flex; align-items: center; justify-content: center; font-weight: 800; cursor: pointer; transition: 0.2s; background: #fff; font-size: 0.75rem; color: #aaa; }
        .day-box.active { color: #fff; border-color: transparent; transform: scale(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .day-box.active:nth-child(5n+1) { background-color: var(--macaron-pink); }
        .day-box.active:nth-child(5n+2) { background-color: var(--macaron-yellow); }
        .day-box.active:nth-child(5n+3) { background-color: var(--macaron-green); }
        .day-box.active:nth-child(5n+4) { background-color: var(--macaron-blue); }
        .day-box.active:nth-child(5n+5) { background-color: var(--macaron-purple); }

        /* æ‚„æ‚„è©±å€å¡Š */
        .message-section { margin-top: 20px; padding: 15px; background: #fff5f8; border-radius: 20px; border: 2px dashed #ffb7b2; }
        .message-title { font-size: 0.85rem; font-weight: 800; color: #ff6b6b; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; justify-content: center; }
        #message-input { width: 100%; border: 1px solid #ffcad4; border-radius: 12px; padding: 10px; font-family: inherit; font-size: 0.9rem; resize: none; outline: none; transition: 0.3s; }
        #message-input:focus { border-color: #ff6b6b; box-shadow: 0 0 8px rgba(255,107,107,0.2); }
        .save-msg-btn { margin-top: 8px; background: #ffb7b2; border: none; padding: 8px 20px; border-radius: 50px; color: white; font-weight: 800; cursor: pointer; width: 100%; transition: 0.3s; }
        .save-msg-btn:active { transform: scale(0.95); background: #ff9a9e; }

        /* æ„›å¿ƒç‰¹æ•ˆæ¨£å¼ */
        .heart { position: fixed; font-size: 20px; pointer-events: none; z-index: 999; animation: fly 1s ease-out forwards; }
        @keyframes fly {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--xdiff), var(--ydiff)) scale(1.5); opacity: 0; }
        }
        
        .streak-fire { display: inline-block; animation: wobble 1s infinite; }
        @keyframes wobble {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 id="title">ğŸ­ æ˜èˆ‡è±çš„é¦¬å¡é¾é‡‘åº«</h1>
        <div class="user-switcher">
            <button class="user-btn" id="btnA" onclick="switchUser('A')">æ˜çš„é€²åº¦</button>
            <button class="user-btn" id="btnB" onclick="switchUser('B')">è±çš„é€²åº¦</button>
        </div>
        <div class="sync-status" id="sync-info">â³ åŒæ­¥ä¸­...</div>
    </header>

    <div class="dashboard">
        <div class="stat-box full-width" onclick="toggleCombined()">
            <div class="stat-label">ğŸ¤ åˆé«”é‡‘åº«ç¸½é¡ <span id="eye-combined">ğŸ™ˆ</span></div>
            <div class="stat-value highlight" id="total-combined">******</div>
        </div>
        <div class="stat-box" onclick="toggleAmount()">
            <div class="stat-label">ğŸ§ æˆ‘çš„é‡‘é¡ <span id="eye-icon">ğŸ™ˆ</span></div>
            <div class="stat-value" id="current-total">******</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">ğŸ”¥ é€£çºŒå­˜éŒ¢</div>
            <div class="stat-value"><span class="streak-fire">ğŸ”¥</span> <span id="streak-days">0</span> å¤©</div>
        </div>
    </div>

    <div class="progress-section">
        <div class="progress-info"><span>ğŸ“… 2026 å¹´é€²åº¦</span><span id="year-percent">0%</span></div>
        <div class="progress-container"><div class="progress-bar bar-2026" id="year-progress"></div></div>
    </div>

    <div class="progress-section">
        <div class="progress-info"><span id="user-progress-label">æˆ‘çš„å­˜éŒ¢é€²åº¦</span><span id="percent-complete">0%</span></div>
        <div class="progress-container"><div class="progress-bar" id="user-progress"></div></div>
    </div>

    <div class="grid" id="grid-container"></div>

    <div class="message-section">
        <div class="message-title">ğŸ’Œ çµ¦å°æ–¹çš„æ‚„æ‚„è©±</div>
        <textarea id="message-input" rows="2" placeholder="å¯«é»ä»€éº¼é¼“å‹µå°æ–¹å§..."></textarea>
        <button class="save-msg-btn" onclick="saveMessage()">å‚³é€é€™ä»½å¿ƒæ„ âœ¨</button>
    </div>
</div>

<script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxact7LMnkFfpvs6S9KUjmo1oZ9QcoI6QK4XcHORd4CTperkdmJi_aLQe9qDCnDnIw/exec';

    let currentUser = 'A';
    let myData = []; 
    let otherData = [];
    let isAmountHidden = true;
    let isCombinedHidden = true;
    const totalDays = 365;
    const grandTotal = (totalDays * (totalDays + 1)) / 2;

    async function init() {
        const params = new URLSearchParams(window.location.search);
        if (params.get('user') === 'B') currentUser = 'B';
        updateUserUI();
        updateYearProgress();
        
        const cache = localStorage.getItem(`money_2026_${currentUser}`);
        if (cache) { myData = JSON.parse(cache); renderGrid(); updateStats(); }
        
        await fetchCloud();
    }

    function updateUserUI() {
        document.getElementById('btnA').classList.toggle('active', currentUser === 'A');
        document.getElementById('btnB').classList.toggle('active', currentUser === 'B');
        document.getElementById('title').textContent = `ğŸ­ ${currentUser === 'A' ? 'æ˜' : 'è±'}çš„é¦¬å¡é¾é‡‘åº«`;
        document.getElementById('user-progress-label').textContent = `${currentUser === 'A' ? 'æ˜' : 'è±'}çš„å­˜éŒ¢é€²åº¦`;
    }

    async function fetchCloud() {
        document.getElementById('sync-info').textContent = "â³ åŒæ­¥ä¸­...";
        try {
            const resA = await fetch(`${GOOGLE_SCRIPT_URL}?user=A`);
            const dataA = await resA.json();
            const resB = await fetch(`${GOOGLE_SCRIPT_URL}?user=B`);
            const dataB = await resB.json();
            const msgRes = await fetch(`${GOOGLE_SCRIPT_URL}?user=MSG`);
            const msgData = await msgRes.json();

            myData = (currentUser === 'A') ? dataA : dataB;
            otherData = (currentUser === 'A') ? dataB : dataA;
            
            if (msgData && msgData.text) {
                document.getElementById('message-input').value = msgData.text;
            }

            renderGrid();
            updateStats();
            document.getElementById('sync-info').textContent = "âœ… å·²åŒæ­¥ " + new Date().toLocaleTimeString();
        } catch (e) {
            document.getElementById('sync-info').textContent = "âš ï¸ é›¢ç·šæ¨¡å¼";
        }
    }

    async function switchUser(user) {
        if (currentUser === user) return;
        currentUser = user;
        updateUserUI();
        await fetchCloud();
    }

    async function saveData() {
        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify({ user: currentUser, savedData: myData })
            });
        } catch (e) {}
    }

    async function saveMessage() {
        const msg = document.getElementById('message-input').value;
        document.getElementById('sync-info').textContent = "â˜ï¸ å‚³é€ä¸­...";
        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify({ user: 'MSG', savedData: { text: msg } })
            });
            document.getElementById('sync-info').textContent = "âœ… æ‚„æ‚„è©±å·²é€é”";
        } catch (e) { alert("é€£ç·šå¤±æ•—"); }
    }

    function createHeart(e) {
        const colors = ['#ff9a9e', '#fad0c4', '#ffb7b2', '#fbc2eb', '#a18cd1'];
        for(let i=0; i<6; i++) {
            const heart = document.createElement('div');
            heart.className = 'heart';
            heart.innerHTML = 'â¤ï¸';
            heart.style.left = (e.clientX || e.touches[0].clientX) + 'px';
            heart.style.top = (e.clientY || e.touches[0].clientY) + 'px';
            heart.style.color = colors[Math.floor(Math.random() * colors.length)];
            heart.style.setProperty('--xdiff', (Math.random() * 200 - 100) + 'px');
            heart.style.setProperty('--ydiff', (Math.random() * -200 - 50) + 'px');
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 1000);
        }
    }

    function renderGrid() {
        const container = document.getElementById('grid-container');
        container.innerHTML = '';
        for (let i = 1; i <= totalDays; i++) {
            const cell = document.createElement('div');
            cell.className = 'day-box' + (myData.includes(i) ? ' active' : '');
            cell.textContent = i;
            cell.onclick = (e) => {
                createHeart(e);
                if (myData.includes(i)) myData = myData.filter(d => d !== i);
                else myData.push(i);
                renderGrid(); updateStats(); saveData();
            };
            container.appendChild(cell);
        }
    }

    function updateStats() {
        const mySum = myData.reduce((a, b) => a + b, 0);
        const otherSum = otherData.reduce((a, b) => a + b, 0);
        const combined = mySum + otherSum;
        const percent = ((mySum / grandTotal) * 100).toFixed(1);

        document.getElementById('total-combined').textContent = isCombinedHidden ? "******" : `$${combined.toLocaleString()}`;
        document.getElementById('eye-combined').textContent = isCombinedHidden ? "ğŸ™ˆ" : "ğŸ‘ï¸";
        
        document.getElementById('current-total').textContent = isAmountHidden ? "******" : `$${mySum.toLocaleString()}`;
        document.getElementById('eye-icon').textContent = isAmountHidden ? "ğŸ™ˆ" : "ğŸ‘ï¸";
        
        document.getElementById('percent-complete').textContent = `${percent}%`;
        document.getElementById('user-progress').style.width = `${percent}%`;
        document.getElementById('streak-days').textContent = myData.length;
    }

    function toggleAmount() { isAmountHidden = !isAmountHidden; updateStats(); }
    function toggleCombined() { isCombinedHidden = !isCombinedHidden; updateStats(); }

    function updateYearProgress() {
        const now = new Date();
        const start = new Date(2026, 0, 1);
        const end = new Date(2027, 0, 1);
        let progress = ((now - start) / (end - start) * 100).toFixed(1);
        if (progress < 0) progress = 0;
        if (progress > 100) progress = 100;
        document.getElementById('year-percent').textContent = `${progress}%`;
        document.getElementById('year-progress').style.width = `${progress}%`;
    }

    init();
</script>
</body>
</html>
