<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ­ 2026 é›™äººé¦¬å¡é¾å­˜éŒ¢æŒ‘æˆ°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');

        :root {
            --macaron-pink: #FFB7B2;
            --macaron-yellow: #FFDAC1;
            --macaron-green: #E2F0CB;
            --macaron-blue: #B5EAD7;
            --macaron-purple: #C7CEEA;
            --bg-gradient: linear-gradient(120deg, #E0C3FC 0%, #8EC5FC 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-color: #4a4a4a; 
            --shadow-soft: 0 10px 25px rgba(162, 162, 255, 0.2);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Nunito', sans-serif;
            background-image: var(--bg-gradient);
            background-attachment: fixed;
            margin: 0; padding: 15px;
            display: flex; justify-content: center; min-height: 100vh;
        }

        .container {
            width: 100%; max-width: 900px;
            background: var(--card-bg);
            border-radius: 25px; padding: 25px;
            box-shadow: var(--shadow-soft);
            backdrop-filter: blur(10px);
            border: 3px solid #fff;
        }

        header { text-align: center; margin-bottom: 20px; }
        h1 { color: #845EC2; font-size: 1.8rem; margin: 0; text-shadow: 2px 2px 0px #fff; }

        .user-switcher {
            display: flex; justify-content: center;
            gap: 10px; margin: 20px 0;
        }
        .user-btn {
            padding: 10px 25px; border-radius: 50px;
            border: 2px solid #845EC2; background: white;
            color: #845EC2; font-weight: 800; cursor: pointer;
            transition: 0.3s;
        }
        .user-btn.active { background: #845EC2; color: white; }
        
        .sync-status { font-size: 0.8rem; color: #666; margin-top: 8px; font-weight: bold; }

        .dashboard { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; }
        .stat-box {
            flex: 1 1 calc(33.33% - 10px);
            text-align: center; padding: 15px; border-radius: 20px;
            min-height: 100px; display: flex; flex-direction: column; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        @media (max-width: 600px) { .stat-box { flex: 1 1 100%; } }

        .stat-box:nth-child(1) { background-color: var(--macaron-blue); }
        .stat-box:nth-child(2) { background-color: var(--macaron-yellow); }
        .stat-box:nth-child(3) { background-color: var(--macaron-pink); }

        .stat-label { font-size: 0.85rem; font-weight: 700; margin-bottom: 5px; opacity: 0.8; }
        .stat-value { font-size: 1.6rem; font-weight: 800; }

        .progress-container {
            width: 100%; background: #eee; border-radius: 50px;
            height: 18px; margin: 20px 0; overflow: hidden; padding: 3px;
            border: 1px solid #ddd;
        }
        .progress-bar {
            height: 100%; width: 0%; border-radius: 50px;
            background: linear-gradient(90deg, var(--macaron-pink), var(--macaron-purple));
            transition: width 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            gap: 10px; margin-top: 20px;
        }
        .day-box {
            aspect-ratio: 1; border-radius: 50%; border: 2px solid #eee;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; cursor: pointer; transition: 0.2s;
            background: #fff; font-size: 0.85rem; color: #888;
        }
        .day-box.active { color: #fff; border-color: transparent; transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .day-box.active:nth-child(5n+1) { background-color: var(--macaron-pink); }
        .day-box.active:nth-child(5n+2) { background-color: var(--macaron-yellow); }
        .day-box.active:nth-child(5n+3) { background-color: var(--macaron-green); }
        .day-box.active:nth-child(5n+4) { background-color: var(--macaron-blue); }
        .day-box.active:nth-child(5n+5) { background-color: var(--macaron-purple); }

        .controls { text-align: center; margin-top: 40px; padding-bottom: 20px; }
        .btn-reset {
            background: #fff; border: 2px solid #FF9AA2; color: #FF9AA2;
            padding: 10px 30px; border-radius: 50px; font-weight: 700; cursor: pointer;
            transition: 0.3s;
        }
        .btn-reset:hover { background: #FF9AA2; color: #fff; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 id="title">ğŸ­ è¼‰å…¥ä¸­...</h1>
        <div class="user-switcher">
            <button class="user-btn active" id="btnA" onclick="switchUser('A')">æˆ‘çš„é€²åº¦</button>
            <button class="user-btn" id="btnB" onclick="switchUser('B')">å¦ä¸€åŠé€²åº¦</button>
        </div>
        <div class="sync-status" id="sync-info">â³ æ­£åœ¨èˆ‡é›²ç«¯åŒæ­¥...</div>
    </header>

    <div class="dashboard">
        <div class="stat-box">
            <div class="stat-label">ğŸ§ ç´¯ç©é‡‘é¡</div>
            <div class="stat-value" id="current-total">$0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">ğŸ“… å®Œæˆå¤©æ•¸</div>
            <div class="stat-value"><span id="days-completed">0</span> / 365</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">ğŸŒˆ é”æˆç‡</div>
            <div class="stat-value" id="percent-complete">0%</div>
        </div>
    </div>

    <div class="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
    </div>

    <div class="grid" id="grid-container"></div>

    <div class="controls">
        <button class="btn-reset" onclick="resetData()">ğŸ¬ é‡ç½®ç›®å‰é é¢</button>
    </div>
</div>

<script>
    // ----------------------------------------------------
    // ã€é‡è¦ã€‘è«‹åœ¨æ­¤è™•å¡«å…¥ä½ çš„ Google Apps Script URL
    // ----------------------------------------------------
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxact7LMnkFfpvs6S9KUjmo1oZ9QcoI6QK4XcHORd4CTperkdmJi_aLQe9qDCnDnIw/exec';

    let currentUser = 'A'; 
    let savedData = [];
    const totalDays = 365;
    const grandTotal = (totalDays * (totalDays + 1)) / 2;

    async function init() {
        // å…ˆæª¢æŸ¥ç¶²å€æœ‰æ²’æœ‰æŒ‡å®šä½¿ç”¨è€… (?user=B)
        const params = new URLSearchParams(window.location.search);
        if (params.get('user') === 'B') currentUser = 'B';
        
        updateUserUI();
        
        // 1. å„ªå…ˆå¾æœ¬åœ°è®€å–ï¼ˆè®“ä½¿ç”¨è€…æ„Ÿè¦ºç§’é–‹ï¼‰
        const localCache = localStorage.getItem(`money_2026_${currentUser}`);
        if (localCache) {
            savedData = JSON.parse(localCache);
            renderGrid();
            updateStats();
        }
        
        // 2. å‘é›²ç«¯è«‹æ±‚æœ€æ–°è³‡æ–™
        await fetchCloud();
    }

    function updateUserUI() {
        document.getElementById('btnA').classList.toggle('active', currentUser === 'A');
        document.getElementById('btnB').classList.toggle('active', currentUser === 'B');
        document.getElementById('title').textContent = `ğŸ­ ${currentUser === 'A' ? 'æˆ‘' : 'å¦ä¸€åŠ'}çš„é¦¬å¡é¾å­˜éŒ¢`;
    }

    async function switchUser(user) {
        if (currentUser === user) return;
        currentUser = user;
        updateUserUI();
        
        // åˆ‡æ›æ™‚æ¸…ç©ºä¸¦é‡æ–°è®€å–è©²ä½¿ç”¨è€…çš„è³‡æ–™
        const localCache = localStorage.getItem(`money_2026_${currentUser}`);
        savedData = localCache ? JSON.parse(localCache) : [];
        
        renderGrid();
        updateStats();
        await fetchCloud();
    }

    async function fetchCloud() {
        document.getElementById('sync-info').textContent = "â³ æ­£åœ¨åŒæ­¥é›²ç«¯...";
        try {
            // åœ¨ç¶²å€å¾ŒåŠ ä¸Š user åƒæ•¸å‚³çµ¦å¾Œç«¯ doGet
            const response = await fetch(`${GOOGLE_SCRIPT_URL}?user=${currentUser}`);
            const cloudData = await response.json();
            
            if (Array.isArray(cloudData)) {
                savedData = cloudData;
                localStorage.setItem(`money_2026_${currentUser}`, JSON.stringify(savedData));
                renderGrid();
                updateStats();
                document.getElementById('sync-info').textContent = "âœ… é›²ç«¯å·²åŒæ­¥ " + new Date().toLocaleTimeString();
            }
        } catch (e) {
            console.error(e);
            document.getElementById('sync-info').textContent = "âš ï¸ é›¢ç·šç‹€æ…‹ (é¡¯ç¤ºæœ¬åœ°è³‡æ–™)";
        }
    }

    async function saveData() {
        // å…ˆå­˜æœ¬åœ°
        localStorage.setItem(`money_2026_${currentUser}`, JSON.stringify(savedData));
        
        // å¾Œå‚³é›²ç«¯
        try {
            document.getElementById('sync-info').textContent = "â˜ï¸ é›²ç«¯å„²å­˜ä¸­...";
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // é—œéµï¼šè§£æ±º Google Apps Script çš„ CORS å•é¡Œ
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: currentUser, savedData: savedData })
            });
            document.getElementById('sync-info').textContent = "âœ… é›²ç«¯å·²å„²å­˜";
        } catch (e) {
            document.getElementById('sync-info').textContent = "âŒ é›²ç«¯å„²å­˜å¤±æ•—";
        }
    }

    function renderGrid() {
        const container = document.getElementById('grid-container');
        container.innerHTML = '';
        for (let i = 1; i <= totalDays; i++) {
            const cell = document.createElement('div');
            cell.className = 'day-box' + (savedData.includes(i) ? ' active' : '');
            cell.textContent = i;
            cell.onclick = () => toggleDay(i, cell);
            container.appendChild(cell);
        }
    }

    function toggleDay(day, el) {
        if (savedData.includes(day)) {
            savedData = savedData.filter(d => d !== day);
            el.classList.remove('active');
        } else {
            savedData.push(day);
            el.classList.add('active');
        }
        updateStats();
        saveData(); // æ¯æ¬¡é»æ“Šè‡ªå‹•å„²å­˜
    }

    function updateStats() {
        const sum = savedData.reduce((a, b) => a + b, 0);
        const count = savedData.length;
        const percent = ((sum / grandTotal) * 100).toFixed(1);

        document.getElementById('current-total').textContent = `$${sum.toLocaleString()}`;
        document.getElementById('days-completed').textContent = count;
        document.getElementById('percent-complete').textContent = `${percent}%`;
        document.getElementById('progress-bar').style.width = `${percent}%`;
    }

    async function resetData() {
        const userName = currentUser === 'A' ? 'æˆ‘' : 'å¦ä¸€åŠ';
        if (confirm(`ç¢ºå®šè¦æ¸…ç©ºã€Œ${userName}ã€çš„é€²åº¦å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼`)) {
            savedData = [];
            renderGrid();
            updateStats();
            await saveData();
        }
    }

    init();
</script>
</body>
</html>
