<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ­ 2026 æ˜èˆ‡è±çš„é¦¬å¡é¾å­˜éŒ¢æŒ‘æˆ°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');

        :root {
            --macaron-pink: #FFB7B2;
            --macaron-yellow: #FFDAC1;
            --macaron-green: #E2F0CB;
            --macaron-blue: #B5EAD7;
            --macaron-purple: #C7CEEA;
            --bg-gradient: linear-gradient(120deg, #E0C3FC 0%, #8EC5FC 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-color: #4a4a4a; 
            --shadow-soft: 0 10px 25px rgba(162, 162, 255, 0.2);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Nunito', sans-serif;
            background-image: var(--bg-gradient);
            background-attachment: fixed;
            margin: 0; padding: 15px;
            display: flex; justify-content: center; min-height: 100vh;
        }

        .container {
            width: 100%; max-width: 900px;
            background: var(--card-bg);
            border-radius: 25px; padding: 25px;
            box-shadow: var(--shadow-soft);
            backdrop-filter: blur(10px);
            border: 3px solid #fff;
        }

        header { text-align: center; margin-bottom: 20px; }
        h1 { color: #845EC2; font-size: 1.8rem; margin: 0; text-shadow: 2px 2px 0px #fff; }

        .user-switcher {
            display: flex; justify-content: center;
            gap: 10px; margin: 20px 0;
        }
        .user-btn {
            padding: 10px 25px; border-radius: 50px;
            border: 2px solid #845EC2; background: white;
            color: #845EC2; font-weight: 800; cursor: pointer;
            transition: 0.3s;
        }
        .user-btn.active { background: #845EC2; color: white; }
        .user-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .sync-status { font-size: 0.8rem; color: #666; margin-top: 8px; font-weight: bold; min-height: 1.2em; }

        .dashboard { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; }
        .stat-box {
            flex: 1 1 calc(33.33% - 10px);
            text-align: center; padding: 15px; border-radius: 20px;
            min-height: 110px; display: flex; flex-direction: column; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            position: relative;
        }
        @media (max-width: 600px) { .stat-box { flex: 1 1 100%; } }

        .stat-box:nth-child(1) { background-color: var(--macaron-blue); cursor: pointer; }
        .stat-box:nth-child(2) { background-color: var(--macaron-yellow); }
        .stat-box:nth-child(3) { background-color: var(--macaron-pink); }

        .stat-label { font-size: 0.85rem; font-weight: 700; margin-bottom: 5px; opacity: 0.8; }
        .stat-value { font-size: 1.4rem; font-weight: 800; line-height: 1.2; }
        .sub-value { font-size: 0.75rem; font-weight: 700; margin-top: 4px; opacity: 0.7; }

        .progress-container {
            width: 100%; background: #eee; border-radius: 50px;
            height: 18px; margin: 20px 0; overflow: hidden; padding: 3px;
            border: 1px solid #ddd;
        }
        .progress-bar {
            height: 100%; width: 0%; border-radius: 50px;
            background: linear-gradient(90deg, var(--macaron-pink), var(--macaron-purple));
            transition: width 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            gap: 10px; margin-top: 20px;
        }
        .day-box {
            aspect-ratio: 1; border-radius: 50%; border: 2px solid #eee;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; cursor: pointer; transition: 0.2s;
            background: #fff; font-size: 0.85rem; color: #888;
        }
        .day-box.active { color: #fff; border-color: transparent; transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .day-box.active:nth-child(5n+1) { background-color: var(--macaron-pink); }
        .day-box.active:nth-child(5n+2) { background-color: var(--macaron-yellow); }
        .day-box.active:nth-child(5n+3) { background-color: var(--macaron-green); }
        .day-box.active:nth-child(5n+4) { background-color: var(--macaron-blue); }
        .day-box.active:nth-child(5n+5) { background-color: var(--macaron-purple); }

        .controls { text-align: center; margin-top: 40px; padding-bottom: 20px; }
        .btn-reset {
            background: #fff; border: 2px solid #FF9AA2; color: #FF9AA2;
            padding: 10px 30px; border-radius: 50px; font-weight: 700; cursor: pointer;
            transition: 0.3s;
        }
        .btn-reset:hover { background: #FF9AA2; color: #fff; }
        
        .eye-icon { font-size: 0.8rem; vertical-align: middle; margin-left: 5px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 id="title">ğŸ­ è¼‰å…¥ä¸­...</h1>
        <div class="user-switcher">
            <button class="user-btn active" id="btnA" onclick="switchUser('A')">æ˜çš„é€²åº¦</button>
            <button class="user-btn" id="btnB" onclick="switchUser('B')">è±çš„é€²åº¦</button>
        </div>
        <div class="sync-status" id="sync-info">â³ åˆå§‹åŒ–ä¸­...</div>
    </header>

    <div class="dashboard">
        <div class="stat-box" onclick="toggleAmount()">
            <div class="stat-label">ğŸ§ ç´¯ç©é‡‘é¡ <span class="eye-icon" id="eye-icon">ğŸ™ˆ</span></div>
            <div class="stat-value" id="current-total">******</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">ğŸ“… å®Œæˆé€²åº¦</div>
            <div class="stat-value"><span id="days-completed">0</span> / 365 å¤©</div>
            <div class="sub-value" id="calendar-text">ç´„ 0 å€‹æœˆåˆ 0 å¤©</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">ğŸŒˆ é”æˆç‡</div>
            <div class="stat-value" id="percent-complete">0%</div>
        </div>
    </div>

    <div class="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
    </div>

    <div class="grid" id="grid-container"></div>

    <div class="controls">
        <button class="btn-reset" onclick="resetData()">ğŸ¬ é‡ç½®ç›®å‰é é¢</button>
    </div>
</div>

<script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxact7LMnkFfpvs6S9KUjmo1oZ9QcoI6QK4XcHORd4CTperkdmJi_aLQe9qDCnDnIw/exec';

    let currentUser = 'A'; 
    let savedData = [];
    let isAmountHidden = true;
    let isSyncing = false; // é˜²æ­¢é‡è¤‡é»æ“ŠåŒæ­¥
    const totalDays = 365;
    const grandTotal = (totalDays * (totalDays + 1)) / 2;
    const daysInMonth2026 = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

    async function init() {
        const params = new URLSearchParams(window.location.search);
        if (params.get('user') === 'B') currentUser = 'B';
        
        updateUserUI();
        
        // å„ªå…ˆé¡¯ç¤ºæœ¬åœ°å¿«å–
        const localCache = localStorage.getItem(`money_2026_${currentUser}`);
        if (localCache) {
            savedData = JSON.parse(localCache);
            renderGrid();
            updateStats();
        }
        
        // å•Ÿå‹•å³èˆ‡é›²ç«¯å°é½Š
        await fetchCloud();
    }

    function updateUserUI() {
        document.getElementById('btnA').classList.toggle('active', currentUser === 'A');
        document.getElementById('btnB').classList.toggle('active', currentUser === 'B');
        document.getElementById('title').textContent = `ğŸ­ ${currentUser === 'A' ? 'æ˜' : 'è±'}çš„é¦¬å¡é¾å­˜éŒ¢`;
    }

    async function switchUser(user) {
        if (currentUser === user || isSyncing) return;
        
        currentUser = user;
        updateUserUI();
        
        // 1. åˆ‡æ›æ™‚å…ˆé¡¯ç¤ºæœ¬åœ°è³‡æ–™ï¼Œè®“ç•«é¢åæ‡‰å¿«
        const localCache = localStorage.getItem(`money_2026_${currentUser}`);
        savedData = localCache ? JSON.parse(localCache) : [];
        renderGrid();
        updateStats();
        
        // 2. è‡ªå‹•å•Ÿå‹•é›²ç«¯åŒæ­¥
        await fetchCloud();
    }

    async function fetchCloud() {
        if (isSyncing) return;
        isSyncing = true;
        
        const syncEl = document.getElementById('sync-info');
        syncEl.textContent = `â³ æ­£åœ¨æŠ“å– ${currentUser === 'A' ? 'æ˜' : 'è±'} çš„æœ€æ–°é€²åº¦...`;
        
        // ç¦ç”¨æŒ‰éˆ•é˜²æ­¢é€£çºŒé»æ“Šé€ æˆè³‡æ–™æ··äº‚
        document.getElementById('btnA').disabled = true;
        document.getElementById('btnB').disabled = true;

        try {
            const response = await fetch(`${GOOGLE_SCRIPT_URL}?user=${currentUser}`);
            const cloudData = await response.json();
            
            if (Array.isArray(cloudData)) {
                savedData = cloudData;
                localStorage.setItem(`money_2026_${currentUser}`, JSON.stringify(savedData));
                renderGrid();
                updateStats();
                syncEl.textContent = "âœ… é›²ç«¯å·²åŒæ­¥ " + new Date().toLocaleTimeString();
            }
        } catch (e) {
            syncEl.textContent = "âš ï¸ é›²ç«¯é€£ç·šå¤±æ•—ï¼Œé¡¯ç¤ºé›¢ç·šè³‡æ–™";
        } finally {
            isSyncing = false;
            document.getElementById('btnA').disabled = false;
            document.getElementById('btnB').disabled = false;
        }
    }

    async function saveData() {
        localStorage.setItem(`money_2026_${currentUser}`, JSON.stringify(savedData));
        const syncEl = document.getElementById('sync-info');
        
        try {
            syncEl.textContent = "â˜ï¸ å„²å­˜è‡³é›²ç«¯ä¸­...";
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: currentUser, savedData: savedData })
            });
            syncEl.textContent = "âœ… å·²è‡ªå‹•å­˜æª”";
        } catch (e) {
            syncEl.textContent = "âŒ å­˜æª”å¤±æ•—";
        }
    }

    function toggleAmount() {
        isAmountHidden = !isAmountHidden;
        updateStats();
    }

    function renderGrid() {
        const container = document.getElementById('grid-container');
        container.innerHTML = '';
        for (let i = 1; i <= totalDays; i++) {
            const cell = document.createElement('div');
            cell.className = 'day-box' + (savedData.includes(i) ? ' active' : '');
            cell.textContent = i;
            cell.onclick = () => toggleDay(i, cell);
            container.appendChild(cell);
        }
    }

    function toggleDay(day, el) {
        if (savedData.includes(day)) {
            savedData = savedData.filter(d => d !== day);
            el.classList.remove('active');
        } else {
            savedData.push(day);
            el.classList.add('active');
        }
        updateStats();
        saveData();
    }

    function updateStats() {
        const sum = savedData.reduce((a, b) => a + b, 0);
        const count = savedData.length;
        const percent = ((sum / grandTotal) * 100).toFixed(1);

        const totalEl = document.getElementById('current-total');
        const eyeEl = document.getElementById('eye-icon');
        if (isAmountHidden) {
            totalEl.textContent = "******";
            eyeEl.textContent = "ğŸ™ˆ";
        } else {
            totalEl.textContent = `$${sum.toLocaleString()}`;
            eyeEl.textContent = "ğŸ‘ï¸";
        }

        document.getElementById('days-completed').textContent = count;
        document.getElementById('percent-complete').textContent = `${percent}%`;
        document.getElementById('progress-bar').style.width = `${percent}%`;

        let tempDays = count;
        let months = 0;
        let days = 0;

        for (let i = 0; i < daysInMonth2026.length; i++) {
            if (tempDays >= daysInMonth2026[i]) {
                tempDays -= daysInMonth2026[i];
                months++;
            } else {
                days = tempDays;
                break;
            }
        }
        document.getElementById('calendar-text').textContent = `ç´„ ${months} å€‹æœˆåˆ ${days} å¤©`;
    }

    async function resetData() {
        const userName = currentUser === 'A' ? 'æ˜' : 'è±';
        if (confirm(`ç¢ºå®šè¦æ¸…ç©ºã€Œ${userName}ã€çš„é€²åº¦å—ï¼Ÿ`)) {
            savedData = [];
            renderGrid();
            updateStats();
            await saveData();
        }
    }

    init();
</script>
</body>
</html>
</body>
</html>

