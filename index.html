<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ­ 2026 æ˜èˆ‡è±çš„æ™‚å…‰é‡‘åº«</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap');
        
        :root {
            /* ç™½å¤©æ¨¡å¼è®Šæ•¸ */
            --bg-gradient: linear-gradient(120deg, #fccb90 0%, #d57eeb 100%);
            --card-bg: rgba(255, 255, 255, 0.9);
            --text-color: #555;
            --jar-glass: rgba(255, 255, 255, 0.4);
        }

        /* æ™šä¸Šæ¨¡å¼æ¨£å¼ */
        body.night-mode {
            --bg-gradient: linear-gradient(120deg, #2c3e50 0%, #000000 100%);
            --card-bg: rgba(30, 30, 50, 0.85);
            --text-color: #eee;
            --jar-glass: rgba(100, 100, 200, 0.2);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Nunito', sans-serif; 
            background-image: var(--bg-gradient); 
            background-attachment: fixed; 
            margin: 0; padding: 10px; 
            display: flex; justify-content: center; min-height: 100vh; 
            color: var(--text-color); 
            transition: all 1s ease;
        }

        .container { width: 100%; max-width: 600px; background: var(--card-bg); border-radius: 30px; padding: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); backdrop-filter: blur(10px); border: 2px solid rgba(255,255,255,0.3); position: relative; }

        header h1 { font-size: 1.5rem; text-align: center; margin: 0; color: #6e45e2; }
        body.night-mode header h1 { color: #a18cd1; }

        .user-switcher { display: flex; justify-content: center; gap: 8px; margin: 15px 0; }
        .user-btn { padding: 8px 20px; border-radius: 50px; border: 2px solid #6e45e2; background: white; color: #6e45e2; font-weight: 800; cursor: pointer; }
        .user-btn.active { background: #6e45e2; color: white; }
        body.night-mode .user-btn { background: #1a1a2e; color: #a18cd1; border-color: #a18cd1; }
        body.night-mode .user-btn.active { background: #a18cd1; color: #1a1a2e; }

        /* è¦–è¦ºåŒ–å­˜éŒ¢ç½ */
        .jar-container { display: flex; justify-content: center; margin: 20px 0; position: relative; }
        .jar {
            width: 100px; height: 140px;
            background: var(--jar-glass);
            border: 3px solid #fff;
            border-radius: 20px 20px 40px 40px;
            position: relative; overflow: hidden;
            box-shadow: inset 0 0 15px rgba(255,255,255,0.5);
        }
        .jar-lid {
            width: 60px; height: 12px;
            background: #ffb7b2;
            position: absolute; top: -10px; left: 50%;
            transform: translateX(-50%);
            border-radius: 5px; z-index: 5;
        }
        .water {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(0deg, #FFB7B2 0%, #C7CEEA 100%);
            transition: height 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; color: white; font-weight: 800;
        }

        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { text-align: center; padding: 12px; border-radius: 20px; background: rgba(255,255,255,0.5); box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; }
        body.night-mode .stat-box { background: rgba(255,255,255,0.1); }
        .full-width { grid-column: span 2; border: 2px dashed #ffb7b2; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(42px, 1fr)); gap: 8px; }
        .day-box { aspect-ratio: 1; border-radius: 50%; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; font-weight: 800; cursor: pointer; background: #fff; font-size: 0.75rem; color: #aaa; }
        body.night-mode .day-box { background: #2c3e50; border-color: #444; color: #666; }
        .day-box.active { color: #fff; border-color: transparent; transform: scale(1.1); box-shadow: 0 0 15px rgba(255,183,178,0.5); }
        
        /* æ‚„æ‚„è©± */
        .message-section { margin-top: 20px; padding: 15px; background: rgba(255,183,178,0.1); border-radius: 20px; border: 1px solid #ffb7b2; }
        #message-input { width: 100%; border-radius: 10px; padding: 10px; border: none; outline: none; background: rgba(255,255,255,0.5); font-family: inherit; }

        /* æ„›å¿ƒç‰¹æ•ˆ */
        .heart { position: fixed; font-size: 20px; pointer-events: none; z-index: 999; animation: fly 1s ease-out forwards; }
        @keyframes fly { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 100% { transform: translate(var(--xdiff), var(--ydiff)) scale(1.5); opacity: 0; } }
    </style>
</head>
<body id="body-tag">

<div class="container">
    <header>
        <h1 id="title">ğŸ­ æ™‚å…‰é‡‘åº«</h1>
        <div class="user-switcher">
            <button class="user-btn" id="btnA" onclick="switchUser('A')">æ˜çš„é€²åº¦</button>
            <button class="user-btn" id="btnB" onclick="switchUser('B')">è±çš„é€²åº¦</button>
        </div>
        <div class="sync-status" id="sync-info" style="text-align: center; font-size: 0.7rem; color: #888;">â³ åŒæ­¥ä¸­...</div>
    </header>

    <div class="jar-container">
        <div class="jar">
            <div class="jar-lid"></div>
            <div class="water" id="jar-water" style="height: 0%;">0%</div>
        </div>
    </div>

    <div class="dashboard">
        <div class="stat-box full-width" onclick="toggleCombined()">
            <div class="stat-label">ğŸ¤ æˆ‘å€‘çš„é¦¬å¡é¾é‡‘åº« <span id="eye-combined">ğŸ™ˆ</span></div>
            <div class="stat-value" id="total-combined">******</div>
        </div>
        <div class="stat-box" onclick="toggleAmount()">
            <div class="stat-label">ğŸ§ æˆ‘çš„ç´¯ç© <span id="eye-icon">ğŸ™ˆ</span></div>
            <div class="stat-value" id="current-total">******</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">ğŸ”¥ é€£çºŒå­˜éŒ¢</div>
            <div class="stat-value"><span id="streak-days">0</span> å¤©</div>
        </div>
    </div>

    <div class="grid" id="grid-container"></div>

    <div class="message-section">
        <div class="message-title" style="text-align:center; font-weight:800; font-size:0.8rem; margin-bottom:10px;">ğŸ’Œ æ‚„æ‚„è©±</div>
        <textarea id="message-input" rows="2" placeholder="å¯«çµ¦å°æ–¹çš„è¨Šæ¯..."></textarea>
        <button onclick="saveMessage()" style="width:100%; margin-top:8px; background:#ffb7b2; border:none; border-radius:50px; padding:8px; color:white; font-weight:800; cursor:pointer;">å‚³é€</button>
    </div>
</div>

<script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxact7LMnkFfpvs6S9KUjmo1oZ9QcoI6QK4XcHORd4CTperkdmJi_aLQe9qDCnDnIw/exec';

    let currentUser = 'A';
    let myData = [], otherData = [];
    let isAmountHidden = true, isCombinedHidden = true;

    async function init() {
        const params = new URLSearchParams(window.location.search);
        if (params.get('user') === 'B') currentUser = 'B';
        
        checkTime();
        updateUserUI();
        await fetchCloud();
    }

    // æ™å¤œæª¢æŸ¥ç³»çµ±
    function checkTime() {
        const hour = new Date().getHours();
        const isNight = hour >= 18 || hour < 6;
        if (isNight) document.getElementById('body-tag').classList.add('night-mode');
    }

    function updateUserUI() {
        document.getElementById('btnA').classList.toggle('active', currentUser === 'A');
        document.getElementById('btnB').classList.toggle('active', currentUser === 'B');
        document.getElementById('title').textContent = `ğŸ­ ${currentUser === 'A' ? 'æ˜' : 'è±'}çš„æ™‚å…‰é‡‘åº«`;
    }

    async function fetchCloud() {
        document.getElementById('sync-info').textContent = "â³ æ­£åœ¨åŒæ­¥é›²ç«¯...";
        try {
            const resA = await fetch(`${GOOGLE_SCRIPT_URL}?user=A`);
            const dataA = await resA.json();
            const resB = await fetch(`${GOOGLE_SCRIPT_URL}?user=B`);
            const dataB = await resB.json();
            const msgRes = await fetch(`${GOOGLE_SCRIPT_URL}?user=MSG`);
            const msgData = await msgRes.json();

            myData = (currentUser === 'A') ? dataA : dataB;
            otherData = (currentUser === 'A') ? dataB : dataA;
            if (msgData && msgData.text) document.getElementById('message-input').value = msgData.text;

            renderGrid();
            updateStats();
            document.getElementById('sync-info').textContent = "âœ… å·²æ›´æ–°æ–¼ " + new Date().toLocaleTimeString();
        } catch (e) {
            document.getElementById('sync-info').textContent = "âš ï¸ é›¢ç·šä¸­";
        }
    }

    function createHeart(e) {
        const heart = document.createElement('div');
        heart.className = 'heart';
        heart.innerHTML = 'â¤ï¸';
        heart.style.left = (e.clientX || (e.touches ? e.touches[0].clientX : 0)) + 'px';
        heart.style.top = (e.clientY || (e.touches ? e.touches[0].clientY : 0)) + 'px';
        heart.style.setProperty('--xdiff', (Math.random() * 200 - 100) + 'px');
        heart.style.setProperty('--ydiff', (Math.random() * -200 - 50) + 'px');
        document.body.appendChild(heart);
        setTimeout(() => heart.remove(), 1000);
    }

    function renderGrid() {
        const container = document.getElementById('grid-container');
        container.innerHTML = '';
        for (let i = 1; i <= 365; i++) {
            const cell = document.createElement('div');
            cell.className = 'day-box' + (myData.includes(i) ? ' active' : '');
            cell.textContent = i;
            cell.onclick = (e) => {
                createHeart(e);
                if (myData.includes(i)) myData = myData.filter(d => d !== i);
                else myData.push(i);
                renderGrid(); updateStats(); saveToCloud();
            };
            container.appendChild(cell);
        }
    }

    function updateStats() {
        const mySum = myData.reduce((a, b) => a + b, 0);
        const totalSum = mySum + otherData.reduce((a, b) => a + b, 0);
        const grandTotal = (365 * 366) / 2;
        const totalPercent = ((totalSum / (grandTotal * 2)) * 100).toFixed(1);

        document.getElementById('current-total').textContent = isAmountHidden ? "******" : `$${mySum.toLocaleString()}`;
        document.getElementById('total-combined').textContent = isCombinedHidden ? "******" : `$${totalSum.toLocaleString()}`;
        document.getElementById('streak-days').textContent = myData.length;
        
        // æ›´æ–°å­˜éŒ¢ç½æ°´ä½
        const jarWater = document.getElementById('jar-water');
        jarWater.style.height = `${totalPercent}%`;
        jarWater.textContent = `${totalPercent}%`;
    }

    async function saveToCloud() {
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST', mode: 'no-cors',
            body: JSON.stringify({ user: currentUser, savedData: myData })
        });
    }

    async function saveMessage() {
        const msg = document.getElementById('message-input').value;
        document.getElementById('sync-info').textContent = "â˜ï¸ å‚³é€ä¸­...";
        await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST', mode: 'no-cors',
            body: JSON.stringify({ user: 'MSG', savedData: { text: msg } })
        });
        document.getElementById('sync-info').textContent = "ğŸ’Œ æ‚„æ‚„è©±å·²é€é”";
    }

    function toggleAmount() { isAmountHidden = !isAmountHidden; updateStats(); }
    function toggleCombined() { isCombinedHidden = !isCombinedHidden; updateStats(); }
    async function switchUser(user) { currentUser = user; updateUserUI(); await fetchCloud(); }

    init();
</script>
</body>
</html>
